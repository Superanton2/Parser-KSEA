import csv
from serpapi import GoogleSearch
# from datetime import datetime

# --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ---

API_KEY = "f2ae2e2cc4ee26a03d44c09eb54e2ca095632ae1105a2b96d49cd89b1dac89a3"
USER_INPUT = {
    "KS–ï –ê–≥—Ä–æ—Ü–µ–Ω—Ç—Ä" : ["",""],
    "–û–ª–µ–≥ –ù—ñ–≤‚Äô—î–≤—Å—å–∫–∏–π" : ["10-10-2024","20-10-2025"], #
    "–ú–∞—Ä—ñ—è –ë–æ–≥–æ–Ω–æ—Å" : ["",""],
    "–ü–∞–≤–ª–æ –ú–∞—Ä—Ç–∏—à–µ–≤" :  ["",""], #
    "–í–∞–ª–µ–Ω—Ç–∏–Ω –õ—ñ—Ç–≤—ñ–Ω–æ–≤" : ["",""], #
    "–Ü–≤–∞–Ω –ö–æ–ª–æ–¥—è–∂–Ω–∏–π" : ["",""],
    "–ï–ª–ª—ñ–Ω–∞ –Æ—Ä—á–µ–Ω–∫–æ" : ["",""],
    "–ì—Ä–∏–≥–æ—Ä—ñ–π –°—Ç–æ–ª—å–Ω—ñ–∫–æ–≤–∏—á" : ["",""],
    "–ê—Ä—Ç—É—Ä –ë—É—Ä–∞–∫" : ["",""],
    "–†–æ–∫—Å–æ–ª–∞–Ω–∞ –ù–∞–∑–∞—Ä–∫—ñ–Ω–∞" : ["",""],
    "–ê–ª—ñ–Ω–∞ –û–¥–∏–Ω–µ—Ü—å" : ["",""],
    "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –ü–µ—Ä–µ—Ö–æ–∂—É–∫" : ["",""],
    "–í—ñ–ª—å—è–º –ú–µ–π—î—Ä—Å" : ["",""],
    "–í–∞—Å–∏–ª—å –ö–≤–∞—Ä—Ç—é–∫" : ["",""],
    "–î–º–∏—Ç—Ä–æ –¢–µ—Å–ª–µ–Ω–∫–æ" : ["",""],
}

OUTPUT_CSV_FILE = "google_news_results.csv"

query = list(USER_INPUT.keys())
date = list(USER_INPUT.values())

MIN_DATE = "01-01-2016"
MAX_DATE = "01-01-2025"

start_date = []
end_date = []

# # —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –¥–∞—Ç
# for item in date:
#     # –ø–æ—á–∞—Ç–æ–∫
#     if item[0] == "":
#         start_date.append("01-01-2016")
#     else:
#         if item[0] < MIN_DATE:
#             start_date.append(MIN_DATE)
#         else:
#             start_date.append(item[0])
#
#     # –∫—ñ–Ω–µ—Ü—å
#     if item[1] == "":
#         end_date.append(datetime.today())
#     if item[1] != "":
#         end_date.append(item[1])




# --- –û—Å–Ω–æ–≤–Ω–∏–π —Å–∫—Ä–∏–ø—Ç ------------------------------

# –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ CSV-—Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å—É –û–î–ò–ù –†–ê–ó –Ω–∞ –ø–æ—á–∞—Ç–∫—É
# newline='' - —Ü–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ—Ö —Ä—è–¥–∫—ñ–≤
with open(OUTPUT_CSV_FILE, 'w', newline='', encoding='utf-8') as csvfile:
    # –°—Ç–≤–æ—Ä—é—î–º–æ "–∑–∞–ø–∏—Å—É–≤–∞—á" —ñ –≤–∏–∑–Ω–∞—á–∞—î–º–æ –Ω–∞–∑–≤–∏ –∫–æ–ª–æ–Ω–æ–∫
    fieldnames = ['–õ—é–¥–∏–Ω–∞', '–ó–∞–≥–æ–ª–æ–≤–æ–∫', '–î–∞—Ç–∞', '–î–∂–µ—Ä–µ–ª–æ','–ü–æ—Å–∏–ª–∞–Ω–Ω—è']
    writer = csv.DictWriter(csvfile, fieldnames=fieldnames)

    # –ó–∞–ø–∏—Å—É—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ —Ñ–∞–π–ª
    writer.writeheader()

    print("Searching...")
    # –ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—è –ø–æ –∫–æ–∂–Ω—ñ–π –ª—é–¥–∏–Ω—ñ –∑—ñ —Å–ø–∏—Å–∫—É
    for person in query:

        # –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è –ø–æ—à—É–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É
        params = {
            "tbm": "nws",  # tbm=nws –æ–∑–Ω–∞—á–∞—î –ø–æ—à—É–∫ —É —Ä–æ–∑–¥—ñ–ª—ñ "–ù–æ–≤–∏–Ω–∏"
            "q": person,  # –ü–æ—à—É–∫–æ–≤–∏–π –∑–∞–ø–∏—Ç
            "num": "100",  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
            "api_key": API_KEY,
            "tbs": f"cdr:1,cd_min:{start_date},cd_max:{end_date}" # –¥–∞—Ç–∞ –∑–∞–ø–∏—Ç—É
        }

        # –í–∏–∫–æ–Ω—É—î–º–æ –∑–∞–ø–∏—Ç –¥–æ SerpApi
        search = GoogleSearch(params)
        results_dict = search.get_dict()

        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –±–ª–æ–∫ 'news_results'
        if 'news_results' in results_dict:
            # –Ø–∫—â–æ —î, –ø—Ä–æ—Ö–æ–¥–∏–º–æ –ø–æ –∫–æ–∂–Ω—ñ–π –∑–Ω–∞–π–¥–µ–Ω—ñ–π –Ω–æ–≤–∏–Ω—ñ
            for news_item in results_dict['news_results']:
                # –ó–∞–ø–∏—Å—É—î–º–æ —Ä—è–¥–æ–∫ —É CSV
                writer.writerow({
                    '–õ—é–¥–∏–Ω–∞': person,
                    '–ó–∞–≥–æ–ª–æ–≤–æ–∫': news_item.get('title'),
                    '–î–∞—Ç–∞': news_item.get('date'),
                    '–î–∂–µ—Ä–µ–ª–æ': news_item.get('source'),
                    '–ü–æ—Å–∏–ª–∞–Ω–Ω—è': news_item.get('link')
                })
            print(f"‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ {len(results_dict['news_results'])} –Ω–æ–≤–∏–Ω.")

        else:
            # –Ø–∫—â–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –Ω–µ–º–∞—î, –∑–∞–ø–∏—Å—É—î–º–æ –ø—Ä–æ —Ü–µ –≤ —Ñ–∞–π–ª
            writer.writerow({
                '–õ—é–¥–∏–Ω–∞': person,
                '–ó–∞–≥–æ–ª–æ–≤–æ–∫': '‚ùå –ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ',
                '–î–∞—Ç–∞': '',
                '–ü–æ—Å–∏–ª–∞–Ω–Ω—è': ''
            })
            print("‚ùå –ù–æ–≤–∏–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")

print(f"\nüéâ –í—Å—è —Ä–æ–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–æ —É —Ñ–∞–π–ª '{OUTPUT_CSV_FILE}'")